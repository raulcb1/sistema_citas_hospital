<?php
//include 'config.php';

if ($_SESSION['rol'] != 'admin') {
    header("Location: sin_permisos.php");
    exit();
}

if (isset($_POST['servicio_id'])){
    $serv_programar = $_POST['servicio_id'];
}

//obtenemos datos del servicio que vamos a programar
$datos_servicio = $conn->query("SELECT * FROM servicios WHERE id = $serv_programar");
$datos_servicio = $datos_servicio->fetch_assoc();
$nombre_servicio = $datos_servicio['nombre'];

$servicios = $conn->query("SELECT id, nombre FROM servicios WHERE activo = 1 AND id = $serv_programar");

?>
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <h1>PROGRAMACIÓN DEL SERVICIO DE <?php echo $nombre_servicio; ?></h1>
        </div>
    </div>
</section>
<section class="content">
    <div class="container-fluid">

        <!-- Botón para abrir el modal de programación recurrente -->
        <button class="btn btn-success" data-toggle="modal" data-target="#modalProgramacionRecurrente">
            <i class="fas fa-calendar-alt"></i> Programación Recurrente
        </button>

        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Vista de Programacion del Servicio de <?php echo $nombre_servicio; ?>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="calendario"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para programación recurrente -->
        <div class="modal fade" id="modalProgramacionRecurrente">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary">
                        <h5 class="modal-title">Programación Recurrente</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <form id="formProgramacionRecurrente" method="POST">
                        <div class="modal-body">
                            <div class="row">
                                <!-- Selección de médico, consultorio y turno -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Médico:</label>
                                        <select name="medico_id" class="form-control" required>
                                            <?php
                                    $medicos = $conn->query("SELECT m.id, u.nombre 
                                                             FROM medicos m 
                                                             INNER JOIN usuarios u ON m.usuario_id = u.id");
                                    while ($medico = $medicos->fetch_assoc()): ?>
                                            <option value="<?php echo $medico['id']; ?>">
                                                <?php echo $medico['nombre']; ?>
                                            </option>
                                            <?php endwhile; ?>
                                        </select>
                                    </div>
                                </div>
                                <!-- <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Consultorio:</label>
                                        <select name="consultorio_id" class="form-control" required>
                                            <?php
                                    $consultorios = $conn->query("SELECT * FROM consultorios");
                                    while ($consultorio = $consultorios->fetch_assoc()): ?>
                                            <option value="<?php echo $consultorio['id']; ?>">
                                                <?php echo $consultorio['nombre']; ?>
                                            </option>
                                            <?php endwhile; ?>
                                        </select>
                                    </div>
                                </div> -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Servicios:</label>
                                        <select name="servicio_id" class="form-control" required>
                                            <?php while ($servicio = $servicios->fetch_assoc()): ?>
                                            <option value="<?php echo $servicio['id']; ?>">
                                                <?php echo $servicio['nombre']; ?>
                                            </option>
                                            <?php endwhile; ?>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Turno:</label>
                                        <select name="turno" class="form-control" required>
                                            <option value="mañana">Mañana</option>
                                            <option value="tarde">Tarde</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Opciones de repetición -->
                            <div class="form-group">
                                <label>Frecuencia:</label>
                                <select id="frecuencia" class="form-control">
                                    <option value="unica">Única</option>
                                    <option value="diaria">Diaria</option>
                                    <option value="semanal">Semanal (días específicos)</option>
                                    <!-- <option value="mensual">Mensual (mismo día cada mes)</option> -->
                                </select>
                            </div>

                            <!-- Selector de rango de fechas -->
                            <!-- <div class="form-group">
                                <label>Rango de Fechas:</label>
                                <div class="input-daterange input-group" id="rangoFechas">
                                    <input type="date" class="form-control" name="fecha_inicio" required>
                                    <div class="input-group-append">
                                        <span class="input-group-text">al</span>
                                    </div>
                                    <input type="date" class="form-control" name="fecha_fin" required>
                                </div>
                            </div> -->




                            <div class="form-group" id="fechaUnica">
                                <label>Fecha:</label>
                                <input type="date" class="form-control" name="fecha_inicio"
                                    value="<?php echo date('Y-m-d'); ?>" required>
                            </div>
                            <div class="form-group" id="rangoFechas" style="display: none;">
                                <label>Rango de Fechas:</label>
                                <div class="input-daterange input-group">
                                    <input type="date" class="form-control" name="fecha_inicio"
                                        value="<?php echo date('Y-m-d'); ?>" required>
                                    <div class="input-group-append">
                                        <span class="input-group-text">al</span>
                                    </div>
                                    <input type="date" class="form-control" name="fecha_fin"
                                        value="<?php echo date('Y-m-d'); ?>" required>
                                </div>
                            </div>




                            <!-- Días de la semana (solo para frecuencia semanal) -->
                            <div class="form-group" id="diasSemana" style="display: none;">
                                <label>Días:</label>
                                <div class="row">
                                    <?php 
                                    $dias = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                                    foreach ($dias as $dia): ?>
                                    <div class="col-md-3">
                                        <div class="icheck-primary">
                                            <input type="checkbox" id="dia_<?php echo strtolower($dia); ?>"
                                                name="dias[]" value="<?php echo $dia; ?>">
                                            <label for="dia_<?php echo strtolower($dia); ?>"><?php echo $dia; ?></label>
                                        </div>
                                    </div>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" name="guardar_recurrente" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Programación
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="plugins/jquery/jquery.min.js"></script>
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="plugins/fullcalendar/6.1.8/locales-all.global.min.js"></script>
<script src="plugins/fullcalendar/6.1.8/index.global.min.js"></script>
<script src="plugins/fullcalendar/6.1.8/daygrid/index.global.min.js"></script>
<script src="plugins/fullcalendar/6.1.8/interaction/index.global.min.js"></script>
<script src="plugins/moment/moment.min.js"></script>
<script src="plugins/sweetalert2/sweetalert2@11.js"></script> <!-- Incluir SweetAlert2 -->
<script>
//Script para el modal de programacion recurrente. 
$(document).ready(function() {
    // Establecer el idioma en español para moment.js
    moment.locale('es');

    // Mostrar/ocultar campos según la frecuencia
    $('#frecuencia').change(function() {
        const frecuencia = $(this).val();
        if (frecuencia === 'unica') {
            $('#rangoFechas').hide(); // Ocultar rango de fechas
            $('#diasSemana').hide(); // Ocultar días de la semana
            $('#fechaUnica').show(); // Mostrar solo fecha_inicio

            // Ajustar atributos 'required'
            $('input[name="fecha_inicio"]').prop('required', true);
            $('input[name="fecha_fin"]').prop('required', false);
            $('input[name="dias[]"]').prop('required', false);
        } else if (frecuencia === 'semanal') {
            $('#fechaUnica').hide(); // Ocultar fecha única
            $('#rangoFechas').show(); // Mostrar rango de fechas
            $('#diasSemana').show(); // Mostrar días de la semana

            // Ajustar atributos 'required'
            $('input[name="fecha_inicio"]').prop('required', true);
            $('input[name="fecha_fin"]').prop('required', true);
            $('input[name="dias[]"]').prop('required', true);
        } else if (frecuencia === 'diaria') {
            $('#fechaUnica').hide(); // Ocultar fecha única
            $('#rangoFechas').show(); // Mostrar rango de fechas
            $('#diasSemana').hide(); // Ocultar días de la semana

            // Ajustar atributos 'required'
            $('input[name="fecha_inicio"]').prop('required', true);
            $('input[name="fecha_fin"]').prop('required', true);
            $('input[name="dias[]"]').prop('required', false);
        }
    });

    // Inicializar el modal con frecuencia "Única"
    $('#modalProgramacionRecurrente').on('show.bs.modal', function() {
        $('#frecuencia').val('unica').trigger('change');
    });

    // Enviar datos al servidor
    $('#formProgramacionRecurrente').submit(function(e) {
        e.preventDefault();
        const formData = $(this).serializeArray();

        // Log para depuración
        console.log('Datos del formulario:', formData);

        // Calcular fechas según la frecuencia
        const fechaInicio = moment(formData.find(f => f.name === 'fecha_inicio').value);
        const fechaFin = moment(formData.find(f => f.name === 'fecha_fin').value);
        const frecuencia = formData.find(f => f.name === 'frecuencia').value;
        const dias = formData.filter(f => f.name === 'dias[]').map(d => d.value);

        let fechas = [];
        let currentDate = fechaInicio.clone();

        while (currentDate <= fechaFin) {
            switch (frecuencia) {
                case 'diaria':
                    fechas.push(currentDate.format('YYYY-MM-DD'));
                    break;
                case 'semanal':
                    if (dias.includes(currentDate.format('dddd'))) {
                        fechas.push(currentDate.format('YYYY-MM-DD'));
                    }
                    break;
                case 'mensual':
                    fechas.push(currentDate.format('YYYY-MM-DD'));
                    currentDate.add(1, 'month');
                    continue; // Saltar el día siguiente
                default: // Única
                    fechas.push(fechaInicio.format('YYYY-MM-DD'));
                    break;
            }
            currentDate.add(1, 'day');
        }

        // Enviar fechas al servidor
        $.ajax({
            url: 'funciones/guardar_asignaciones_recurrentes.php',
            method: 'POST',
            data: {
                medico_id: formData.find(f => f.name === 'medico_id').value,
                consultorio_id: formData.find(f => f.name === 'servicio_id').value,
                turno: formData.find(f => f.name === 'turno').value,
                fechas: fechas
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('¡Éxito!', 'Asignaciones guardadas correctamente.',
                        'success');
                    $('#modalProgramacionRecurrente').modal('hide');
                    calendar.refetchEvents(); // Recargar el calendario
                } else {
                    Swal.fire('Error', response.error, 'error');
                }
            }
        });
    });
});
</script>

<script>
//Script para el calendario de programacion de consultorios.
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendario');
    console.log(calendarEl); // Verificar si el contenedor está presente
    if (calendarEl) {
        var calendar = new FullCalendar.Calendar(calendarEl, {
            //plugins: [ 'interaction', 'dayGrid' ],
            locale: 'es',
            initialView: 'dayGridMonth',
            timeZone: 'America/Lima', // Establecer la zona horaria de Lima, Perú
            aspectRatio: 2, // Ajusta esta proporción según tus necesidades
            themeSystem: 'bootstrap6',
            headerToolbar:{start:"today",center:"title",end:"prev,next"},
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'Día',
                list: 'Lista'
            },
            dayMaxEvents: true, // allow "more" link when too many events
            selectable: true,
            /*dateClick: function(info) {
                $('#fechaSeleccionada').val(info.dateStr);
                $('#modalAsignacion').modal('show');
            },*/
            /*eventClick: function(info) {
                // Actualizar los elementos del modal con los detalles del evento
                $('#eventoServicio').text(info.event.extendedProps.servicio);
                $('#eventoMedico').text(info.event.extendedProps.medico);
                $('#eventoTurno').text(info.event.extendedProps.turno);
                // Mostrar el modal
                $('#modalEvento').modal('show');
            },*/
            dateClick: function(info) {
                // Llamar a una función para cargar los eventos del día seleccionado
                cargarEventosDelDia(info.dateStr);
            },

            eventClick: function(info) {
                Swal.fire({
                    title: 'Asignación Existente',
                    html: `<b>Consultorio:</b> ${info.event.extendedProps.servicio}<br>
                               <b>Médico:</b> ${info.event.extendedProps.medico}<br>
                               <b>Turno:</b> ${info.event.extendedProps.turno}`,
                    icon: 'info'
                });
            },
            /*
            events: 'funciones/get_asignaciones.php?servicio_id=<?php echo $serv_programar; ?>',
            */
            events: function(fetchInfo, successCallback, failureCallback) {
                // Obtener el ID del servicio desde algún lugar (por ejemplo, un select)
                const servicioId = <?php echo json_encode($serv_programar); ?>;

                // Construir la URL con el parámetro servicio_id
                const url =
                    `funciones/get_asignaciones.php?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}&servicio_id=${servicioId}`;

                // Hacer la solicitud fetch
                fetch(url)
                    .then(response => response.json())
                    .then(data => successCallback(data))
                    .catch(error => failureCallback(error));
            },
        });
        calendar.render();
    } else {
        console.error("Contenedor del calendario no encontrado");
    }

    $('#formAsignacion').submit(function(e) {
        e.preventDefault();
        $.ajax({
            url: 'funciones/guardar_asignaciones_recurrentes.php',
            method: 'POST',
            data: {
                medico_id: $('#medico_id').val(),
                servicio_id: $('#servicio_id').val(),
                fecha: $('#fechaSeleccionada').val(),
                turno: $('#turno').val()
            },
            success: function(response) {
                if (response.success) {
                    calendar.refetchEvents();
                    $('#modalAsignacion').modal('hide');
                } else {
                    //alert(response.error);
                    alert(JSON.stringify(response.error));
                }
            }
        });
    });

    $('#servicio_id, #fechaSeleccionada, #turno').change(function() {
        // Validación en tiempo real
    });
});

function cargarEventosDelDia(fecha) {
    $.ajax({
        url: 'funciones/get_eventos_dia.php', // Ruta para obtener eventos del día
        method: 'GET',
        data: {
            fecha: fecha
        },
        success: function(response) {
            mostrarEventosEnModal(response); // Mostrar los eventos en un modal
        },
        error: function(xhr, status, error) {
            console.error('Error al cargar eventos:', error);
        }
    });
}

function mostrarEventosEnModal(eventos) {
    // Agrupar eventos por turno
    const eventosPorTurno = {};
    eventos.forEach(evento => {
        if (!eventosPorTurno[evento.turno]) {
            eventosPorTurno[evento.turno] = [];
        }
        eventosPorTurno[evento.turno].push(evento);
    });

    // Construir el contenido del modal
    let contenido = '';
    for (const turno in eventosPorTurno) {
        contenido += `<h4>Turno: ${turno}</h4>`;
        contenido += '<ul>';
        eventosPorTurno[turno].forEach(evento => {
            contenido += `<li>${evento.servicio} - ${evento.medico}</li>`;
        });
        contenido += '</ul>';
    }

    // Mostrar el modal
    $('#modalEventos .modal-body').html(contenido);
    $('#modalEventos').modal('show');
}
</script>
